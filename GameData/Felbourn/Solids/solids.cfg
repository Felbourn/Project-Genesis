
@PART[*]:HAS[@VARS:HAS[#solid_fuel_engine[*]]]:FOR[zPhase2Engines]
{
	%ACTIONS
	{
		action = ensure ModuleEnginesRF
	}

	@MODULE[ModuleEngines*]
	{
		@name = ModuleEnginesRF
		@PROPELLANT[SolidFuel]
		{
			@name = HTPB
		}
	}
}

@PART[*]:HAS[@VARS:HAS[#solid_fuel_engine[default]]]:FOR[zPhase2Engines]
{
	%ACTIONS
	{
		action = calculate solid rocket maxThrust
	}
	@MODULE[ModuleEnginesRF]
	{
		@maxThrust = #$/MODULE[ModuleFuelTanks]/volume$
		@maxThrust *= #$@MM_VARS/SolidMassPerLiter$
		@maxThrust *= #$@MM_VARS/SolidTWR$
		@maxThrust *= #$@MM_VARS/Gravity$
		@maxThrust /= #$@MM_VARS/KgPerTon$
	}
}

@PART[*]:HAS[@VARS:HAS[#solid_fuel_engine[*]]&@VARS:HAS[~solid_fuel_engine[default]]]:FOR[zPhase2Engines]
{
	%ACTIONS
	{
		action = override solid rocket maxThrust
	}
	@MODULE[ModuleEnginesRF]
	{
		@maxThrust = #$/VARS/solid_fuel_engine$
	}
}

@PART[*]:HAS[@VARS:HAS[#solid_fuel_engine[*]]]:FOR[zPhase2Engines]
{
	%ACTIONS
	{
		action = define ModuleEngineConfigs for solid thrust curves
	}
	MODULE
	{
		name = ModuleEngineConfigs
		type = ModuleEnginesRF
		configuration = #$/VARS/solid_burn_pattern$
		
		CONFIG
		{
			name = Linear
			thrustCurve
			{
				key = 0.00 0.01
				key = 0.02 0.01
				key = 0.03 0.16
				key = 0.06 0.32
				key = 1.00 1.00
			}
		}
		CONFIG
		{
			name = MaxQ
			thrustCurve
			{
				key = 0.00 0.01
				key = 0.02 0.01
				key = 0.03 0.16
				key = 0.04 0.20
				key = 0.60 0.99
				key = 0.80 0.60
				key = 0.94 1.00
				key = 1.00 0.90
			}
		}
		CONFIG
		{
			name = Delayed
			thrustCurve
			{
				key = 0.00 0.00
				key = 0.01 0.01
				key = 0.03 0.20
				key = 0.60 0.98
				key = 0.61 0.97
				key = 0.78 0.22
				key = 1.00 0.10
			}
		}
		CONFIG
		{
			name = Fast
			thrustCurve
			{
				key = 0.00 0.05
				key = 0.01 0.11
				key = 1.00 1.00
			}
		}
	}
    %VARS
	{
		isp_sl = #$@MM_VARS/solid_stats[0]$
		@isp_sl *= #$@MM_VARS/solid_stats[1]$
	}
}

@PART[*]:HAS[@VARS:HAS[#solid_fuel_engine[*]]]:FOR[zPhase2Engines]
{
	%ACTIONS
	{
		action = define ModuleEngineConfigs defaults
	}
	@MODULE[ModuleEngineConfigs]
	{
		@CONFIG,*
		{		
			minThrust = 0
			maxThrust = #$/MODULE[ModuleEnginesRF]/maxThrust$
			chamberNominalTemp = 1800
			maxEngineTemp = 2050
			PROPELLANT
			{
				name = HTPB
				ratio = 1
				DrawGauge = True
			}
			atmosphereCurve
			{
				key = #0 $@MM_VARS/solid_stats[0]$
				key = #1 $/VARS/isp_sl$
				key = 3 0.001
			}
			curveResource = HTPB
		}
	}
}
