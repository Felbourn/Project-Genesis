
//=== Plumes ===
// Alcolox-Lower-A6
// Ammonialox
// Hydrogen-NTR
// Hydrolox-Lower
// Hydrolox-Upper
// Hydynelox-A7
// Hypergolic-Apollo-SM
// Hypergolic-Lower
// Hypergolic-Upper
// Hypergolic-OMS-Red
// Hypergolic-OMS-White
// Hypergolic-Vernier
// Ion-Argon-Gridded
// Ion-Krypton-Gridded
// Ion-Krypton-Hall
// Ion-Xenon-Gridded
// Ion-Xenon-Gridded
// Ion-Xenon-Hall
// Kerolox-Lower
// Kerolox-Lower-F1
// Kerolox-Upper
// Kerolox-Vernier
// Solid-Lower
// Solid-Upper
// Solid-Sepmotor
// Solid-Vacuum
// Turbofan
// Turbojet

@PART[*]:HAS[@MODULE[ModuleEngine*],!MODULE[ModuleEngineConfigs],!MODULE[TweakScale]]:BEFORE[zPhase2Engines]
{
    // untested engines can be tweaked to determine best size before locking one in
    MODULE
    {
        name = TweakScale
        type = free
    }
}

@PART[*]:HAS[@MODULE[ModuleEngineConfigs]]:BEFORE[zPhase2Engines]
{
    %ACTIONS
    {
        action = remove ModuleEngineConfigs
    }
	!MODULE[ModuleEngineConfigs],* {}
}

@PART[*]:HAS[@VARS:HAS[#engine_thrust[*]]]:AFTER[zPhase2Engines]
{
    %ACTIONS
    {
        action = set new engine thrust
    }
    @MODULE[ModuleEngines*]
    {
        @name = ModuleEnginesFX
        @maxThrust = #$/VARS/engine_thrust$
        !PROPELLANT,* {}
    }
    %VARS
    {
        %isp_sl = #$/VARS/isp_v$
    }   
}

@PART[*]:HAS[@VARS:HAS[#engine_type[Hydrolox]]]:AFTER[zPhase2Engines]
{
    %ACTIONS
    {
        action = set Hydrolox fuel stats
    }
    %VARS
    {
        @isp_sl *= #$@MM_VARS/HydroloxIspSL$
    }
    @MODULE[ModuleEngines*]
    {
        PROPELLANT
        {
            name = LqdHydrogen
            DrawGauge = True
            ratio = 1
            @ratio /= #$@RESOURCE_DEFINITION[LqdHydrogen]/density$
        }
        PROPELLANT
        {
            name = LqdOxygen
            ratio = #$@MM_VARS/LqdOxygen2LqdHydrogen$
            @ratio /= #$@RESOURCE_DEFINITION[LqdOxygen]/density$
        }
    }
}

@PART[*]:HAS[@VARS:HAS[#engine_type[Kerolox]]]:AFTER[zPhase2Engines]
{
    %ACTIONS
    {
        action = set Kerolox fuel stats
    }
    %VARS
    {
        @isp_sl *= #$@MM_VARS/KeroloxIspSL$
    }
    @MODULE[ModuleEngines*]
    {
        PROPELLANT
        {
            name = Kerosene
            DrawGauge = True
            ratio = 1
            @ratio /= #$@RESOURCE_DEFINITION[Kerosene]/density$
        }
        PROPELLANT
        {
            name = LqdOxygen
            ratio = #$@MM_VARS/LqdOxygen2Kerosene$
            @ratio /= #$@RESOURCE_DEFINITION[LqdOxygen]/density$
        }
    }
}

@PART[*]:HAS[@VARS:HAS[#engine_type[UDMH]]]:AFTER[zPhase2Engines]
{
    %ACTIONS
    {
        action = set UDMH stats
    }
    %VARS
    {
        @isp_sl *= #$@MM_VARS/HypergolicIspSL$
    }
    @MODULE[ModuleEngines*]
    {
        PROPELLANT
        {
            name = UDMH
            DrawGauge = True
            ratio = 1
            @ratio /= #$@RESOURCE_DEFINITION[UDMH]/density$
        }
        PROPELLANT
        {
            name = NTO
            ratio = #$@MM_VARS/NTO2UDMH$
            @ratio /= #$@RESOURCE_DEFINITION[NTO]/density$
        }
    }    
}

@PART[*]:HAS[@VARS:HAS[#engine_type[Hydrazine]]]:AFTER[zPhase2Engines]
{
    %ACTIONS
    {
        action = set Hydrazine stats
    }
    %VARS
    {
        @isp_sl *= #$@MM_VARS/HydrazineIspSL$
    }
    @MODULE[ModuleEngines*]
    {
        PROPELLANT
        {
            name = Hydrazine
            ratio = 1
        }
    }    
}

@PART[*]:HAS[@PLUME[*]]:AFTER[zPhase2Engines]
{
    %ACTIONS
    {
        action = set Isp curve
    }
    @MODULE[ModuleEngines*]
    {
        @atmosphereCurve
        {           
            @key,0 = #0 $/VARS/isp_v$
            @key,1 = #1 $/VARS/isp_sl$
        }
    }
}

@PART[*]:HAS[@MODULE[ModuleEnginesFX]&@PLUME[*]]:AFTER[zPhase2Engines]
{
    %ACTIONS
    {
        action = set FX plume effect name
    }
 	@MODULE[ModuleEnginesFX]
    {
        %powerEffectName = #$/PLUME/name$
    }
}

@PART[*]:HAS[@MODULE[ModuleEngineConfigs]]:AFTER[zPhase2Engines]
{
    %ACTIONS
    {
        action = set RF plume effect name
    }
    @MODULE[ModuleEngineConfigs]
    {
        @CONFIG,*
        {
	        %powerEffectName = #$/PLUME/name$
        }
    }    
}
