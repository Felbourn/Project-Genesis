
@PART[*]:HAS[@MODULE[ModuleFuelTanks]]:AFTER[zPhase1Init]
{
	%ACTIONS
	{
		action = remove ModuleFuelTanks
	}
	!MODULE[ModuleFuelTanks],* {}
}

@PART[*]:HAS[@MOD_TANK[*]]:AFTER[zPhase1Init]
{
	%ACTIONS
	{
		action = add empty ModuleFuelTanks
	}
	@MOD_TANK,*:HAS[~type[]]
	{
		type = Default
	}
	@MOD_TANK,*:HAS[~count[]]
	{
		count = 1
	}
	MODULE
	{
		name = ModuleFuelTanks
		type = #$/MOD_TANK/type$   // even if there are a few, the first one defines the type
		volume = 0
	}
}

@PART[*]:HAS[@MOD_TANK[Pill]]:AFTER[zPhase1Init]
{
	%ACTIONS
	{
		action = add pill ModuleFuelTanks
	}
	MOD_TANK
	{
		name = Can
		type = #$/MOD_TANK[Pill]/type$ 
		dia = #$/MOD_TANK[Pill]/dia$
		hgt = #$/MOD_TANK[Pill]/hgt$
		@hgt -= #$/MOD_TANK[Pill]/dia$
		util = #$/MOD_TANK[Pill]/util$
		count = #$/MOD_TANK[Pill]/count$
	}
	MOD_TANK
	{
		name = Globe
		type = #$/MOD_TANK[Pill]/type$ 
		dia = #$/MOD_TANK[Pill]/dia$
		util = #$/MOD_TANK[Pill]/util$
		count = #$/MOD_TANK[Pill]/count$
	}
}

@PART[*]:HAS[@MOD_TANK[Can]]:AFTER[zPhase1Init]
{
	%ACTIONS
	{
		action = add cylinder ModuleFuelTanks
	}
	@MODULE[ModuleFuelTanks]
	{
		canVolume = #$/MOD_TANK[Can]/dia$
		@canVolume *= #$@MM_VARS/DiamToRadius$
		@canVolume != #$@MM_VARS/Squared$
		@canVolume *= #$@MM_VARS/PI$
		@canVolume *= #$/MOD_TANK[Can]/hgt$
		@canVolume *= #$/MOD_TANK[Can]/count$
		@canVolume *= #$/MOD_TANK[Can]/util$
		@volume += #$canVolume$
	}
}

@PART[*]:HAS[@MOD_TANK[Can2]]:AFTER[zPhase1Init]
{
	%ACTIONS
	{
		action = add a few cylinder ModuleFuelTanks
	}
	@MODULE[ModuleFuelTanks]
	{
		canVolume2 = #$/MOD_TANK[Can2]/dia$
		@canVolume2 *= #$@MM_VARS/DiamToRadius$
		@canVolume2 != #$@MM_VARS/Squared$
		@canVolume2 *= #$@MM_VARS/PI$
		@canVolume2 *= #$/MOD_TANK[Can2]/hgt$
		@canVolume2 *= #$/MOD_TANK[Can2]/count$
		@canVolume2 *= #$/MOD_TANK[Can2]/util$
		@volume += #$canVolume2$
	}
}

@PART[*]:HAS[@MOD_TANK[Globe]]:AFTER[zPhase1Init]
{
	%ACTIONS
	{
		action = add sphere ModuleFuelTanks
	}
	@MODULE[ModuleFuelTanks]
	{
		globeVolume = #$/MOD_TANK[Globe]/dia$
		@globeVolume *= #$@MM_VARS/DiamToRadius$
		@globeVolume != #$@MM_VARS/Cubed$
		@globeVolume *= #$@MM_VARS/PI$
		@globeVolume *= #$@MM_VARS/SphereRatio$
		@globeVolume *= #$/MOD_TANK[Globe]/count$
		@globeVolume *= #$/MOD_TANK[Globe]/util$
		@volume += #$globeVolume$
	}
}

@PART[*]:HAS[@MOD_TANK[Box]]:AFTER[zPhase1Init]
{
	%ACTIONS
	{
		action = add sphere ModuleFuelTanks
	}
	@MODULE[ModuleFuelTanks]
	{
		boxVolume = #$/MOD_TANK[Box]/wid$
		@boxVolume *= #$/MOD_TANK[Box]/hgt$
		@boxVolume *= #$/MOD_TANK[Box]/dep$
		@boxVolume *= #$/MOD_TANK[Box]/count$
		@boxVolume *= #$/MOD_TANK[Box]/util$
		@volume += #$boxVolume$
	}
}

@PART[*]:HAS[@MODULE[ModuleFuelTanks]]:AFTER[zPhase1Init]
{
	%ACTIONS
	{
		action = finalize fuel tank volume
	}
	@MODULE[ModuleFuelTanks]
	{
		@volume *= #$@MM_VARS/LitersPerCM$
	}	
}

@PART[*]:HAS[@MOD_TANK:HAS[#baseMass[true]]]:BEFORE[zPhase7Cleanup]
{
	%ACTIONS
	{
		action = tank has no PV mass because baseMass is set
	}
	@MODULE[ModuleFuelTanks]
	{
		basemass = #$/mass$
	}
}
