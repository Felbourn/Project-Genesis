
@PART[*]:HAS[#mass[*]]:AFTER[zPhase5Mass]
{
	%VARS
	{
		old_mass = #$/mass$
	}
}
@PART[*]:HAS[#mass[*]]:AFTER[zPhase5Mass]
{
	%ACTIONS
	{
		action = clear mass
	}
	@mass = 0 // init to 0, then add masses by traits
}

@PART[*]:HAS[@MASS[OldValue]]:AFTER[zPhase5Mass]
{
	%ACTIONS
	{
		action = use author's mass
	}
	@mass = #$/VARS/old_mass$
}

@PART[*]:HAS[@MODULE[ModuleFuelTanks]:HAS[#type[Default]]]:AFTER[zPhase5Mass]
{
	%ACTIONS
	{
		action = add mass from ModuleFuelTanks
	}
	change = #$/MODULE[ModuleFuelTanks]/volume$
	@change *= #$@MM_VARS/FuelMassPerLiter$
	@change /= #$@MM_VARS/KgPerTon$
	@mass += #$change$
	!change = DELETE
}

@PART[*]:HAS[@MODULE[ModuleFuelTanks]:HAS[#type[Solid]]]:AFTER[zPhase5Mass]
{
	%ACTIONS
	{
		action = add mass from solid fuel volume
	}
	change = #$/MODULE[ModuleFuelTanks]/volume$
	@change *= #$@MM_VARS/SolidMassPerLiter$
	@change /= #$@MM_VARS/KgPerTon$
	@change += #$change$
	@mass += #$change$
	!change = DELETE
}

@PART[*]:HAS[@MASS[Engine]]:AFTER[zPhase5Mass]
{
	%ACTIONS
	{
		action = add mass from maxThrust
	}
	change = #$/MODULE[ModuleEnginesFX]/maxThrust$
	@change /= #$/VARS/TWR_type$
	@change /= #$@MM_VARS/Gravity$
	@mass += #$change$
	!change = DELETE
}

@PART[*]:HAS[@MASS[RCS]]:AFTER[zPhase5Mass]
{
	%ACTIONS
	{
		action = add mass from RCS
	}
	change = #$/MODULE[ModuleRCSFX]/thrusterPower$
	@change /= #$@MM_VARS/RCS_TWR$
	@change /= #$@MM_VARS/Gravity$
	@change *= #$/VARS/RCS_directions$
	@mass += #$change$
	!change = DELETE
}

@PART[*]:HAS[@MASS[BoxVolume]]:AFTER[zPhase5Mass]
{
	// V = w * h * d

	%ACTIONS
	{
		action = add mass from box volume
	}
	change = #$/MASS[BoxVolume]/wid$
	@change *= #$/MASS[BoxVolume]/hgt$
	@change *= #$/MASS[BoxVolume]/dep$
	@change *= #$/MASS[BoxVolume]/density$
	@mass += #$change$

	!change = DELETE
}

@PART[*]:HAS[@MASS[SphereVolume]]:AFTER[zPhase5Mass]
{
	// V = 4/3 pi r^3

	%ACTIONS
	{
		action = add mass from sphere volume
	}
	change = #$/MASS/dia$
	@change *= #$@MM_VARS/DiamToRadius$
	@change != #$@MM_VARS/Cubed$
	@change *= #$@MM_VARS/PI$
	@change *= #$@MM_VARS/SphereRatio$
	@change *= #$/MASS[SphereVolume]/density$
	@mass += #$change$

	!change = DELETE
}

@PART[*]:HAS[@RESOURCE[ElectricCharge]]:AFTER[zPhase5Mass]
{
	%ACTIONS
	{
		action = add mass from battery charge
	}
	change = #$/RESOURCE[ElectricCharge]/amount$
	@change *= #$@MM_VARS/TonsPerWattHour$
	@mass += #$change$

	!change = DELETE
}

@PART[*]:HAS[@VARS:HAS[#comm_mass[*]]]:AFTER[zPhase5Mass]
{
	%ACTIONS
	{
		action = add mass from comm antenna
	}
	@mass += #$/VARS/comm_mass$
}

@PART[*]:HAS[@VARS:HAS[#commandWatts[*]]]:AFTER[zPhase5Mass]
{
	%ACTIONS
	{
		action = add mass from CPU battery
	}
	@mass += #$@MM_VARS/CPUMass$
	!change = DELETE
}

@PART[*]:HAS[@MODULE[ModuleReactionWheel]]:AFTER[zPhase5Mass]
{
	%ACTIONS
	{
		action = add mass from CMG torque
	}
	change = #$/MODULE[ModuleReactionWheel]/PitchTorque$
	@change *= #$@MM_VARS/TonsPerTorque$
	@mass += #$change$
	!change = DELETE
}

@PART[*]:HAS[@MODULE[ModuleDeployableSolarPanel]]:AFTER[zPhase5Mass]
{
	%ACTIONS
	{
		action = add mass from solar array rect
	}
	change = #$/MODULE[ModuleDeployableSolarPanel]/chargeRate$
	@change *= #$@MM_VARS/SolarMass$
	@mass += #$change$
	!change = DELETE
}

@PART[*]:HAS[@MODULE[ModuleCurvedSolarPanel]]:AFTER[zPhase5Mass]
{
	%ACTIONS
	{
		action = add mass from solar array round
	}
	change = #$/MODULE[ModuleCurvedSolarPanel]/TotalEnergyRate$
	@change *= #$@MM_VARS/SolarMass$
	@mass += #$change$
	!change = DELETE
}

@PART[*]:HAS[@MASS[CanArea]]:AFTER[zPhase5Mass]
{
	%ACTIONS
	{
		action = set CanArea mass defaults
	}
	@MASS[CanArea]:HAS[~arcs[]]
	{
		arcs = 1
	}
	@MASS[CanArea]:HAS[~ends[]]
	{
		ends = 0
	}
}
@PART[*]:HAS[@MASS[CanArea]]:AFTER[zPhase5Mass]
{
	%ACTIONS
	{
		action = set mass from cylinder surface area
	}

	// top & bottom A = pi * r^2

	change = #$/MASS[CanArea]/dia$
	@change *= #$@MM_VARS/DiamToRadius$
	@change != #$@MM_VARS/Squared$
	@change *= #$@MM_VARS/PI$
	@change *= #$/MASS[CanArea]/dep$
	@change *= #$/MASS[CanArea]/density$
	@change *= #$/MASS[CanArea]/ends$

	// lateral A = pi * d * h

	lateral = #$/MASS[CanArea]/dia$
	@lateral *= #$@MM_VARS/PI$
	@lateral *= #$/MASS[CanArea]/hgt$
	@lateral *= #$/MASS[CanArea]/dep$
	@lateral *= #$/MASS[CanArea]/density$

	@change += #$lateral$
	@change /= #$/MASS[CanArea]/arcs$
	@mass += #$change$

	!change = DELETE
	!lateral = DELETE
}

@PART[*]:HAS[@MASS[CanVolume]]:AFTER[zPhase5Mass]
{
	%ACTIONS
	{
		action = add mass from cylinder volume
	}
	// V = pi * r^2 * h

	change = #$/MASS[CanVolume]/dia$
	@change *= #$@MM_VARS/DiamToRadius$
	@change != #$@MM_VARS/Squared$
	@change *= #$@MM_VARS/PI$
	@change *= #$/MASS[CanVolume]/hgt$
	@change *= #$/MASS[CanVolume]/density$
	@mass += #$change$

	!change = DELETE
}

@PART[*]:HAS[@MASS[TruncConeVolume]]:AFTER[zPhase5Mass]
{
	%ACTIONS
	{
		action = add mass from truncated cone volume
	}
	// V = pi * h * (r^2 + Rr + R^2)/3

	topRadius = #$/MASS[TruncConeVolume]/diaTop$
	@topRadius *= #$@MM_VARS/DiamToRadius$
	topRadius2 = #$topRadius$
	@topRadius2 != #$@MM_VARS/Squared$

	botRadius = #$/MASS[TruncConeVolume]/diaBot$
	@botRadius *= #$@MM_VARS/DiamToRadius$
	botRadius2 = #$botRadius$
	@botRadius2 != #$@MM_VARS/Squared$

	change = #$topRadius$
	@change *= #$botRadius$
	@change += #$topRadius2$
	@change += #$botRadius2$
	@change /= 3
	@change *= #$@MM_VARS/PI$
	@change *= #$/MASS[TruncConeVolume]/hgt$
	@change *= #$/MASS[TruncConeVolume]/density$

	@mass += #$change$

	!change = DELETE
	!topRadius = DELETE
	!topRadius2 = DELETE
	!botRadius = DELETE
	!botRadius2 = DELETE
}

//-------------------------------------------------------------------------------------------------
// SQRT(x) calculator
//-------------------------------------------------------------------------------------------------

//-- things that need a SQRT ----------------------------------------------------------------------

@PART[*]:HAS[@MASS[ConeArea]]:AFTER[zPhase5Mass]
{
	%ACTIONS
	{
		action = add mass from cone area
	}
	// lateral A = pi r sqrt(h^2 + r^2)

	radius = #$/MASS[ConeArea]/dia$
	@radius *= #$@MM_VARS/DiamToRadius$
	radius2 = #$radius$
	@radius2 != #$@MM_VARS/Squared$

	sqrt_of = #$/MASS[ConeArea]/hgt$
	@sqrt_of != #$@MM_VARS/Squared$
	@sqrt_of += #$radius2$
}

@PART[*]:HAS[@MASS[TruncConeArea]]:AFTER[zPhase5Mass]
{
	%ACTIONS
	{
		action = add mass from tuncated cone surface area
	}
	// lateral A = pi * (r1 + r2) * sqrt( (r1 - r2)^2 + h^2 )

	hgt_sq = #$/MASS[TruncConeArea]/hgt$
	@hgt_sq != #$@MM_VARS/Squared$

	r1 = #$/MASS[TruncConeArea]/diaTop$
	@r1 *= #$@MM_VARS/DiamToRadius$

	r2 = #$/MASS[TruncConeArea]/diaBot$
	@r2 *= #$@MM_VARS/DiamToRadius$

	sqrt_of = #$r1$
	@sqrt_of -= #$r2$
	@sqrt_of != #$@MM_VARS/Squared$

	@sqrt_of += #$hgt_sq$

	!hgt_sq = DELETE
}

@PART[*]:HAS[@MASS[FairingCone]]:AFTER[zPhase5Mass]
{
	%ACTIONS
	{
		action = add mass from fairing cone volume
	}
	// lateral A = pi * r * sqrt(h^2 + r^2)

	radius = #$/MASS[FairingCone]/dia$
	@radius *= #$@MM_VARS/DiamToRadius$
	
	radius2 = #$radius$
	@radius2 != #$@MM_VARS/Squared$

	sqrt_of = #$/MASS[FairingCone]/hgt$
	@sqrt_of != #$@MM_VARS/Squared$
	@sqrt_of += #$radius2$
}

//-- calculator -----------------------------------------------------------------------------------

@PART[*]:HAS[#sqrt_of[*]]:AFTER[zPhase5Mass]
{
	// iterate a few times to refine the sqrt guess
	// f(x) = x^2 - top
	// f'(x) = 2x
	// x' = x - f(x) / f'(x)

	x_value = #$sqrt_of$
	@x_value /= 13

	// iteration 1
	sqrt_fx = #$x_value$
	@sqrt_fx != #$@MM_VARS/Squared$
	@sqrt_fx -= #$sqrt_of$
	@sqrt_fx /= #$x_value$
	@sqrt_fx *= -0.5
	@x_value += #$sqrt_fx$

	// iteration 2
	sqrt_fx = #$x_value$
	@sqrt_fx != #$@MM_VARS/Squared$
	@sqrt_fx -= #$sqrt_of$
	@sqrt_fx /= #$x_value$
	@sqrt_fx *= -0.5
	@x_value += #$sqrt_fx$

	// iteration 3
	sqrt_fx = #$x_value$
	@sqrt_fx != #$@MM_VARS/Squared$
	@sqrt_fx -= #$sqrt_of$
	@sqrt_fx /= #$x_value$
	@sqrt_fx *= -0.5
	@x_value += #$sqrt_fx$

	// iteration 4
	sqrt_fx = #$x_value$
	@sqrt_fx != #$@MM_VARS/Squared$
	@sqrt_fx -= #$sqrt_of$
	@sqrt_fx /= #$x_value$
	@sqrt_fx *= -0.5
	@x_value += #$sqrt_fx$

	// iteration 5
	sqrt_fx = #$x_value$
	@sqrt_fx != #$@MM_VARS/Squared$
	@sqrt_fx -= #$sqrt_of$
	@sqrt_fx /= #$x_value$
	@sqrt_fx *= -0.5
	@x_value += #$sqrt_fx$

	// iteration 6
	sqrt_fx = #$x_value$
	@sqrt_fx != #$@MM_VARS/Squared$
	@sqrt_fx -= #$sqrt_of$
	@sqrt_fx /= #$x_value$
	@sqrt_fx *= -0.5
	@x_value += #$sqrt_fx$

	// final
	sqrt_is = #$x_value$

	!sqrt_of = DELETE
	!x_value = DELETE
	!sqrt_fx = DELETE
}

//-- use SQRT results -----------------------------------------------------------------------------

@PART[*]:HAS[@MASS[ConeArea]]:AFTER[zPhase5Mass]
{
	// lateral A = pi r sqrt(h^2 + r^2)

	change = #$sqrt_is$
	@change *= #$@MM_VARS/PI$
	@change *= #$radius$
	@change *= #$/MASS[ConeArea]/dep$
	@change *= #$/MASS[ConeArea]/density$
	@change /= #$/MASS[ConeArea]/arcs$

	@mass += #$change$

	!change = DELETE
	!radius = DELETE
	!radius2 = DELETE
	!massTypeConeArea = DELETE
	!sqrt_is = DELETE
}

@PART[*]:HAS[@MASS[TruncConeArea]]:AFTER[zPhase5Mass]
{
	// lateral A = pi * (r1 + r2) * sqrt( (r1 - r2)^2 + h^2 )
	// top & bottom A = pi * r1^2 + pi * r2^2

	change = #$r1$
	@change += #$r2$
	@change *= #$sqrt_is$
	@change *= #$@MM_VARS/PI$
	@change *= #$/MASS[TruncConeArea]/dep$
	@change *= #$/MASS[TruncConeArea]/density$
	@mass += #$change$

	!change = DELETE
	!r1 = DELETE
	!r2 = DELETE
	!sqrt_is = DELETE
}

@PART[*]:HAS[@MASS[FairingCone]]:AFTER[zPhase5Mass]
{
	// half cone = pi * r * sqrt(h^2 + r^2)
	// half can = 2 * pi * r * h
	// so A = pi * r * (sqrt / 2 + h)

	change = #$sqrt_is$
	@change /= 2
	@change += #$/MASS[FairingCone]/hgt$
	@change *= #$@MM_VARS/PI$
	@change *= #$radius$
	@change *= #$/MASS[FairingCone]/dep$
	@change /= #$/MASS[FairingCone]/arcs$
	@change *= #$@MM_VARS/FairingMass$
	@mass += #$change$

	!change = DELETE
	!radius = DELETE
	!radius2 = DELETE
	!sqrt_is = DELETE
}

//-------------------------------------------------------------------------------------------------
// still needs a MASS section
@PART[*]:HAS[#mass[0]]:AFTER[zPhase5Mass]
{
	@mass = 9999
}
